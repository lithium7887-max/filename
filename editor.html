<!DOCTYPE html>
<html lang="ko" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <title>ë‚˜ë§Œì˜ ê³ í™”ì§ˆ ì›¹ ì‚¬ì§„ í¸ì§‘ íˆ´ ğŸ¨</title>

    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; text-align: center; padding: 20px; }
        .toolbar { margin-bottom: 10px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: inline-block; }
        .button-group { margin-bottom: 10px; }
        .control-group { background: #f9f9f9; padding: 10px; border-radius: 5px; display: inline-block; border: 1px solid #ddd; margin: 0 5px; }
        button, input[type="file"], select { padding: 8px 15px; margin: 0 3px; cursor: pointer; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; transition: 0.2s; vertical-align: middle; }
        button:hover { background-color: #e9e9e9; }
        #btnSave { background-color: #4CAF50; color: white; border-color: #4CAF50; font-weight: bold; }
        #btnSave:hover { background-color: #45a049; }
        #btnSticker { background-color: #fff3e0; border-color: #ffcc80; font-weight: bold; }
        #btnSticker:hover { background-color: #ffe0b2; }
        input[type="color"], input[type="range"] { vertical-align: middle; cursor: pointer; }
        
        .canvas-container-wrapper { width: 100%; max-width: 100%; overflow: auto; margin-top: 20px; display: flex; justify-content: center; }
        .canvas-container { box-shadow: 0 5px 15px rgba(0,0,0,0.2); background-color: white; }
        
        .help-text { background: #e8f0fe; color: #1a73e8; padding: 15px; border-radius: 8px; font-size: 15px; margin-bottom: 20px; display: inline-block; text-align: left; line-height: 1.6; border: 1px solid #c2e0ff; }
        .help-text b { color: #d93025; }
    </style>
</head>
<body>

    <h2>ë‚˜ë§Œì˜ ê³ í™”ì§ˆ ì›¹ ì‚¬ì§„ í¸ì§‘ íˆ´ ğŸ¨</h2>
    
    <div class="help-text">
        ğŸ” <b>ë§ˆìš°ìŠ¤ íœ </b>: í™•ëŒ€/ì¶•ì†Œ &nbsp;&nbsp;|&nbsp;&nbsp; ğŸ–ï¸ <b>Alt + ë“œë˜ê·¸</b>: í™”ë©´ ì´ë™ &nbsp;&nbsp;|&nbsp;&nbsp; ğŸ—‘ï¸ <b>Backspace / Delete</b>: ê°ì²´ ì‚­ì œ
    </div>

    <div class="toolbar">
        <div class="button-group">
            <input type="file" id="imageLoader" accept="image/*" title="ë°°ê²½ìœ¼ë¡œ ì“¸ ì›ë³¸ ì‚¬ì§„ ì„ íƒ" />
            <button id="btnRect">ğŸŸ¥ ë¹ˆ ì‚¬ê°í˜•</button>
            <button id="btnHollowCircle">â­• ë¹ˆ ì›</button>
            <button id="btnCircle">ğŸ”µ ê½‰ ì°¬ ì›</button>
            <button id="btnArrow">â†—ï¸ í™”ì‚´í‘œ</button>
            <button id="btnText">ğŸ“ í…ìŠ¤íŠ¸</button>
            <button id="btnDelete">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
            <button id="btnSave">ğŸ’¾ ê³ í™”ì§ˆ ì €ì¥</button>
        </div>
        
        <div>
            <div class="control-group">
                <label>ğŸ¨ ìƒ‰ìƒ: <input type="color" id="colorPicker" value="#FF0000"></label>
                <span style="margin: 0 10px; color:#ccc;">|</span>
                <label>ğŸ“ ì„  ë‘ê»˜: <input type="range" id="lineWidth" min="1" max="50" value="10"></label>
            </div>
            
            <div class="control-group" style="background: #fff3e0; border-color: #ffcc80;">
                <label>ğŸ˜€ ì´ëª¨ì§€: 
                    <select id="emojiSelect">
                        <option value="â­">â­ ë³„</option>
                        <option value="â¤ï¸">â¤ï¸ í•˜íŠ¸</option>
                        <option value="ğŸ‘">ğŸ‘ ë”°ë´‰</option>
                        <option value="âœ…">âœ… ì²´í¬</option>
                        <option value="â­•">â­• ë¹ˆ ë™ê·¸ë¼ë¯¸(O)</option>
                        <option value="âŒ">âŒ ì—‘ìŠ¤í‘œ</option>
                        <option value="â“">â“ ë¬¼ìŒí‘œ</option>
                        <option value="â—">â— ëŠë‚Œí‘œ</option>
                        <option value="ğŸ’¯">ğŸ’¯ êµ¿ (100ì )</option>
                        <option value="ğŸ‘">ğŸ‘ ë°°ë“œ (ìš°ìš°~)</option>
                        <option value="ğŸ†—">ğŸ†— ì˜¤ì¼€ì´ (ë§ˆí¬)</option>
                        <option value="ğŸ˜Š">ğŸ˜Š ìŠ¤ë§ˆì¼</option>
                        <option value="ğŸ”¥">ğŸ”¥ ë¶ˆê½ƒ</option>
                        <option value="âœ¨">âœ¨ ë°˜ì§ì´</option>
                        <option value="ì›ƒ">ì›ƒ (ì¡¸ë¼ë§¨)</option>
                        <option value="ì˜·">ì˜· (ë§Œì„¸ë§¨)</option>
                        <option value="ğŸƒ">ğŸƒ ë‹¬ë¦¬ëŠ” ì‚¬ëŒ</option>
                        <option value="ğŸ•º">ğŸ•º ì¶¤ì¶”ëŠ” ì‚¬ëŒ</option>
                        <option value="ğŸ¤º">ğŸ¤º íœì‹± (ì‹¸ìš°ëŠ” ì‚¬ëŒ)</option>
                        <option value="ğŸ‘ GOOD!">ğŸ‘ GOOD! (ê¸€ì)</option>
                        <option value="ğŸ‘ BAD...">ğŸ‘ BAD... (ê¸€ì)</option>                    </select>
                </label>
                <button id="btnEmoji">â• ë„£ê¸°</button>
                <span style="margin: 0 10px; color:#ff9800;">|</span>
                <input type="file" id="stickerLoader" accept="image/*" style="display: none;" />
                <button id="btnSticker">ğŸŒŸ ë‚´ ìŠ¤í‹°ì»¤ ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <div class="canvas-container-wrapper">
        <canvas id="myCanvas" width="800" height="400"></canvas>
    </div>

    <script>
        if (typeof fabric !== 'undefined') {
            fabric.Text.prototype.textBaseline = 'bottom';
            fabric.IText.prototype.textBaseline = 'bottom';
            fabric.Object.prototype.cornerSize = 20;
            fabric.Object.prototype.transparentCorners = false;
        }

        window.onload = function() {
            const canvas = new fabric.Canvas('myCanvas');
            const colorPicker = document.getElementById('colorPicker');
            const lineWidthSlider = document.getElementById('lineWidth');
            const emojiSelect = document.getElementById('emojiSelect');

            // 1. ë°°ê²½ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('imageLoader').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imgObj = new Image();
                    imgObj.src = event.target.result;
                    imgObj.onload = function() {
                        canvas.setWidth(this.width);
                        canvas.setHeight(this.height);
                        const image = new fabric.Image(imgObj);
                        canvas.setBackgroundImage(image, canvas.renderAll.bind(canvas), { scaleX: 1, scaleY: 1, originX: 'left', originY: 'top', left: 0, top: 0 });
                        canvas.setViewportTransform([1,0,0,1,0,0]);
                    };
                };
                reader.readAsDataURL(file);
            });

            // 2. ì¤Œ & íŒ¨ë‹ ê¸°ëŠ¥
            canvas.on('mouse:wheel', function(opt) {
                var delta = opt.e.deltaY;
                var zoom = canvas.getZoom();
                zoom *= 0.999 ** delta;
                if (zoom > 20) zoom = 20;
                if (zoom < 0.1) zoom = 0.1; 
                canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
                opt.e.preventDefault();
                opt.e.stopPropagation();
            });

            canvas.on('mouse:down', function(opt) {
                if (opt.e.altKey === true) {
                    this.isDragging = true;
                    this.selection = false;
                    this.lastPosX = opt.e.clientX;
                    this.lastPosY = opt.e.clientY;
                }
            });

            canvas.on('mouse:move', function(opt) {
                if (this.isDragging) {
                    var vpt = this.viewportTransform;
                    vpt[4] += opt.e.clientX - this.lastPosX;
                    vpt[5] += opt.e.clientY - this.lastPosY;
                    this.requestRenderAll();
                    this.lastPosX = opt.e.clientX;
                    this.lastPosY = opt.e.clientY;
                }
            });

            canvas.on('mouse:up', function(opt) {
                this.isDragging = false;
                this.selection = true;
            });

            // 3. ë„í˜• ë° í…ìŠ¤íŠ¸ ì¶”ê°€
            
            // [ìˆ˜ì •] ë¹ˆ ì‚¬ê°í˜•: strokeUniform: true ì¶”ê°€
            document.getElementById('btnRect').addEventListener('click', function() {
                const rect = new fabric.Rect({ 
                    left: 100, top: 100, width: 300, height: 200, 
                    fill: 'transparent', 
                    stroke: colorPicker.value, 
                    strokeWidth: parseInt(lineWidthSlider.value), 
                    transparentCorners: false,
                    strokeUniform: true // í•µì‹¬: í¬ê¸°ê°€ ë³€í•´ë„ ì„  ë‘ê»˜ë¥¼ ê· ì¼í•˜ê²Œ ìœ ì§€!
                });
                canvas.add(rect); canvas.setActiveObject(rect);
            });

            // [ìˆ˜ì •] ë¹ˆ ì›: strokeUniform: true ì¶”ê°€
            document.getElementById('btnHollowCircle').addEventListener('click', function() {
                const circle = new fabric.Circle({ 
                    left: 120, top: 120, radius: 150, 
                    fill: 'transparent', 
                    stroke: colorPicker.value, 
                    strokeWidth: parseInt(lineWidthSlider.value), 
                    transparentCorners: false,
                    strokeUniform: true // í•µì‹¬: í¬ê¸°ê°€ ë³€í•´ë„ ì„  ë‘ê»˜ë¥¼ ê· ì¼í•˜ê²Œ ìœ ì§€!
                });
                canvas.add(circle); canvas.setActiveObject(circle);
            });

            document.getElementById('btnCircle').addEventListener('click', function() {
                const circle = new fabric.Circle({ left: 150, top: 150, radius: 100, fill: colorPicker.value, transparentCorners: false });
                canvas.add(circle); canvas.setActiveObject(circle);
            });

            document.getElementById('btnArrow').addEventListener('click', function() {
                const arrowPath = 'M 0 20 L 80 20 L 80 0 L 120 30 L 80 60 L 80 40 L 0 40 Z';
                const arrow = new fabric.Path(arrowPath, { left: 200, top: 200, fill: colorPicker.value, transparentCorners: false });
                canvas.add(arrow); canvas.setActiveObject(arrow);
            });

            document.getElementById('btnText').addEventListener('click', function() {
                const text = new fabric.IText('ë”ë¸”í´ë¦­í•´ì„œ ìˆ˜ì •', { left: 150, top: 50, fontFamily: 'sans-serif', fill: colorPicker.value, fontSize: 80 });
                canvas.add(text); canvas.setActiveObject(text);
            });

            document.getElementById('btnEmoji').addEventListener('click', function() {
                const emojiChar = emojiSelect.value;
                const emojiText = new fabric.Text(emojiChar, { left: 200, top: 200, fontSize: 150, transparentCorners: false });
                canvas.add(emojiText); canvas.setActiveObject(emojiText);
            });

            // ë‚´ ìŠ¤í‹°ì»¤ ì¶”ê°€
            document.getElementById('btnSticker').addEventListener('click', function() {
                document.getElementById('stickerLoader').click();
            });
            document.getElementById('stickerLoader').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imgObj = new Image();
                    imgObj.src = event.target.result;
                    imgObj.onload = function() {
                        const sticker = new fabric.Image(imgObj);
                        const maxSize = canvas.width * 0.2;
                        let scale = 1;
                        if (sticker.width > maxSize) scale = maxSize / sticker.width;
                        sticker.set({ scaleX: scale, scaleY: scale, transparentCorners: false });
                        canvas.add(sticker); canvas.viewportCenterObject(sticker); canvas.setActiveObject(sticker);
                        e.target.value = ''; 
                    };
                };
                reader.readAsDataURL(file);
            });

            // 4. ì‹¤ì‹œê°„ ì†ì„± ë³€ê²½
            colorPicker.addEventListener('input', function(e) {
                const obj = canvas.getActiveObject();
                if (obj) {
                    if (obj.type === 'i-text' || obj.type === 'text' || obj.fill !== 'transparent') obj.set('fill', e.target.value);
                    if (obj.stroke && obj.fill === 'transparent') obj.set('stroke', e.target.value);
                    canvas.renderAll();
                }
            });

            lineWidthSlider.addEventListener('input', function(e) {
                const obj = canvas.getActiveObject();
                if (obj && obj.fill === 'transparent') { obj.set('strokeWidth', parseInt(e.target.value, 10)); canvas.renderAll(); }
            });

            // 5. ì‚­ì œ ê¸°ëŠ¥
            document.getElementById('btnDelete').addEventListener('click', function() {
                const activeObject = canvas.getActiveObject();
                if (activeObject) canvas.remove(activeObject);
            });
            window.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' || e.key === 'Delete') {
                    const activeObject = canvas.getActiveObject();
                    if (activeObject) {
                        if (activeObject.isEditing) return; 
                        canvas.remove(activeObject);
                        e.preventDefault(); 
                    }
                }
            });

            // 7. ê³ í™”ì§ˆ ì €ì¥
            document.getElementById('btnSave').addEventListener('click', function() {
                canvas.discardActiveObject(); canvas.renderAll();
                const currentVpt = canvas.viewportTransform.slice();
                canvas.setViewportTransform([1,0,0,1,0,0]);
                const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0, enableRetinaScaling: true });
                canvas.setViewportTransform(currentVpt);
                const link = document.createElement('a');
                link.download = 'ë‚˜ë§Œì˜_ê³ í™”ì§ˆ_í¸ì§‘ì‚¬ì§„.png';
                link.href = dataURL; document.body.appendChild(link);
                link.click(); document.body.removeChild(link);
            });
        };
    </script>
</body>
</html>